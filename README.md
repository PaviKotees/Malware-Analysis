# Malware Research
**Summary:** Self hosting a Malware Analysis Laboratory using Flare VM and Remnux.

#### Table of Contents

 1. [Introduction](#introduction)
    - [Topology](#topology)
    - [Tools Used for Analysis](#tools-used-for-analysis)
    - [Malware Analyzed](#malware-analyzed)
 2. [Installation of Flare VM](#installation-of-flare-vm)
 3. [Zeus Banking Trojan and Analysis](#zeus-banking-trojan-and-analysis)
    
      - [Fingerprint and Properties of Zeus Malware](#fingerprint-and-properties-of-zeus-malware)
      - [Static Analysis of Zeus Malware](#static-analysis-of-zeus-malware)
      - [Dynamic Analysis of Zeus Malware](#dynamic-analysis-of-zeus-malware)

# Introduction

**Platforms used to build self-hosted Malware Analysis Lab:**

- **Oracle VirtualBox** - Detonating malware onto our main working system is not advised, hence the use of VirtualBox to create a sandbox environment.

- **Flare VM** - installed on Windows 10 base machine is a collection of software installation scripts for Windows systems that allows the setup of a analysis lab and reverse engineering environment in Virtual Machine(VM). This machine is where the malware will be installed and detonated.

- **Remnux** - similar version of Flare VM but for Linux OS, this machine will be used as a C2 server during dynamic analysis of malware.

Upon passing the [CompTIA Security+](https://www.comptia.jp/pdf/CompTIA%20Security+%20SY0-601%20Exam%20Objectives%20(3.0).pdf), I realized that I needed hands on experience with malware hence I decided to create a Malware Analysis Lab and document the process.

In this page, I will be documenting the important steps I followed to setup a Malware Analysis Lab with [FlareVM](https://github.com/mandiant/flare-vm) and Remnux. Later on I will be analysing various malware and list out their fingerprints, behaviours, Indicators of Compromise (IoCs) etc.

### **Topology**

<img src="https://github.com/PaviKotees/pavikotees/assets/154454339/5ab64857-5f3d-47a3-b4d7-c4bf9ef09216" height="50%" width="50%"/>


Will be utilized during Dynamic Analysis.

### **Tools used for Analysis**

- VirusTotal - Analyze files and URLs for viruses, worms, trojan and other kinds of malicious content.
- Pestudio - Used to statically analyze executlable files for malicious artifacts
- Capa - The tool supports both malware triage and deep dive reverse engineering.
- Procmon - Process Monitor is used for real-time monitoring of all file system acitivity.
- Wireshark - Open-source packet analyzer. It is used for network troubleshooting and analysis.

### **Malware Analyzed**

- Zeus Banking Trojan
- 

  **Overview of analysis**

  - Fingerprint of the malware
  - Static Analysis
  - Dynamic Analysis

# The Project

## Installation of Flare VM

To be able to create the laboratory it is important know the working of Oracle Virtualbox since that is our base and install Windows 10 Enterprise with atleast 75GB of allocated memory to avoid storage issues.

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/8f7ea96f-0866-4092-b69c-1aff705cb700" height="50%" width="50%"/>

Domain join the Windows 10 machine and fill out the required fields.

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/8278e290-ad86-4c36-9987-ca1ca011a126" height="50%" width="50%"/>

Disable the Windows Defender Firewall on this machine, this step is required since this is the machine we will be installing [Flare VM](https://github.com/mandiant/flare-vm), detailed steps provided in the link, containing all the tools required to analyze the malware. Windows Defender will block Flare VM and the malware, as it should, if enabled. ( not recommended in the environment you work in or any other personal environment )

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/050473b4-e475-471a-910f-ebcab3977c7c" height="50%" width="50%"/>

**Create a snapshot of the machine, to restore machine to this point if anything goes wrong when installing Flare VM or when running malware.**

Download the Flare VM installation file : https://github.com/mandiant/flare-vm/blob/main/install.ps1 onto the Windows 10 VM.

Run PowerShell as administrator:

- Run: ```Unblock-File .\install.ps1``` to unblock the installer.
- Run: ```Set-ExecutionPolicy Unrestricted```
- Run ```.\install.ps1```

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/6d82edb2-ce96-4275-a570-9d35e6b62a35" height="50%" width="50%"/>

Flare VM takes a few hours to install, it restarts plenty of times and finally starts with the Flare OS installed.

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/ad55d256-ae2a-4480-ba52-0493914f9e63" height="44%" width="44%"/>  <img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/5693a251-c8b5-4f30-a467-348354508a32" height="50%" width="50%"/>

## Zeus Banking Trojan and analysis:

Zeus malware can give attackers full access to infected machines  or gain access to an infected computerâ€™s banking credentials and other financial information, many forms of the Zeus virus can also be used to add CryptoLocker ransomware to an operating system or add infected computers to a botnet to perform distributed denial-of-service (DDoS) attacks.

### [Downloading Zeus Banking Trojan (Exercise caution)](https://github.com/ytisf/theZoo/tree/master/malware/Binaries/ZeusBankingVersion_26Nov2013)

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/e6a0428f-2cb4-4840-82d8-2d842845e533" height="50%" width="50%"/> <img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/90d87873-021e-4ac2-9b35-5fa055633bc1" height="48%" width="48%"/>

## Fingerprint and properties of Zeus Malware:

- The trojan is labelled as **"invoice"** as a form of social engineering to trick people into clicking on it.
- The trojan also has the extension *".pdf"* to make it believable but is followed by *".exe"* which indicates that it is a executable which is the *first indicator of malware*

#### **VirusTotal Fingerprint Analysis:**

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/c4e8e454-f31e-4b18-b79d-933eaf25bea9" height="48%" width="48%"/> <img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/f2725462-7d11-41ff-b72a-b84697c78c31" height="48%" width="48%"/>

- Uploading the file to VirusTotal and the application identifies this file has been flagged by 64 vendors as malicious.
- VirusTotal also provides the various hashes of the file which can used as identification of the file across various vendors and platforms.

#### **Pestudio Fingerprint Analysis:**

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/f44762e7-a6d7-47d5-bd12-1a1371cf8e33" height="48%" width="48%"/><img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/3ad2c723-339b-467e-800d-eb212ec7ac18" height="48%" width="48%"/>

- The **SHA256** hash value is the same when analyzed using VirusTotal and Pestudio.
- Pestudio labels executables with *M Z* tag on the first-bytes > text hence proving that it is not a pdf file.

## Static Analysis of Zeus Malware

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/3e14cfc7-bcc6-49f0-803d-6c152b05c7fd" height="48%" width="48%"/>

- The raw-size and virtual-size of the Zeus Malware is similar indicating that it is not a packed executable file. A packed executable has a core payload surrounded by arbitary code in order to change the size of the file which is a method used to confuse the antivirus software.

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/d387d11a-55a6-43fa-9c61-31977cc5526b" height="48%" width="48%"/> <img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/c23c9d3e-6e98-47a2-a8c7-3af89da2a21f" height="48%" width="48%"/>

- Pestudio identifies strings and flags it as malicious. *KERNEL32.CreateFile* is a API call which indicates control over the kernel. These types of strings are buried in between arbitrary strings, which might be used to hiding the strings.
- [*KERNEL32.CreateFile*](https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea) - Creates or opens a file or I/O device.

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/6b6302dd-b237-4f21-b8c9-5febb14e11d0" height="48%" width="48%"/>

- Analyzing the file using **Capa**, we can yet again identify the hash values.
- **Capa** also links the malware to the [MITRE ATT&CK](https://attack.mitre.org/) allowing us to understand more about the techniques used by the malware.
- [DEFENSE EVASION -> Virtualization/Sandbox Evasion](https://attack.mitre.org/techniques/T1497/)

## Dynamic Analysis of Zeus Malware

For dynamic analysis we are going to be needing [Remnux](https://app.box.com/s/8matvs5l0gc8vkr4xfq3szdm7mc9o0ad). Remnux includes [INetSim](https://docs.remnux.org/discover-the-tools/explore+network+interactions/services) which can emulate common network services and interact with malware. In this case, we will be emulating a DNS server.

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/7fec1b04-576c-4cbb-a7d8-bc6838ede72f" height="48%" width="48%"/>

After configuring the Flare VM and remnux to be on the same network, configure Flare VM's DNS address to Remnux's IP address. When running ```inetsim``` on the Remnux machine, the DNS server will start simulating. Above screenshot shows Flare VM accessing the internet via Remnux's DNS.

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/2fbde44d-73b5-4e1d-a689-4d3d70594a1e" height="48%" width="48%"/> <img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/a1749bac-7c4e-4dcb-9d5b-b80b70e1b818" height="48%" width="48%"/>

- With Procmon running, we can try to run the malware file which is followed by the system asking permission for *Adobe Flash Player* and the .exe malware file disappears.

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/e4cca865-42cc-4a11-89c8-305f57c7c409" height="48%" width="48%"/>

- The process tree tab in Procmon allows us to see granular level of processes that were executed. As shown in the screenshot above, when the malware under the name *invoice* was executed, proceeded to execute multiple .exe which a .pdf should not have done.
- The file probably tried to install illegimate flash player from the internet and as soon as that happened, it deleted itself from the user's sight.
- The file then executes *cmd.exe* which is followed by *Conhost.exe* - console host allowing for a invisible terminal session.

**Performing network analysis using Wireshark after executing the file**

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/a87e6d78-3dca-49cd-a56b-1395fda6b75b" height="48%" width="48%"/> <img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/c68129fd-a195-43f3-9b40-b0a8434f55ca" height="48%" width="48%"/>

- After executing the file once again, it passes a GET request as hightlighted in the screenshot.
- Following the TCP stream, it maps to a domain *http://fpdownload.macromedia.com/*

<img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/14e9a419-3389-4879-8aa7-e1c4749a56ff" height="48%" width="48%"/> <img src="https://github.com/PaviKotees/Malware-Analysis/assets/154454339/f523154f-427c-42e0-be79-9f8f31251859" height="48%" width="48%"/>

- Trying to analyze the website in VirusTotal shows that the website is marked malicious by 1 vendor while **89 vendors** marked the website as clean and the website redirects to a legitimate Adobe website which is strange.

### That concludes my analysis on the Zeus Malware. It has helped me obtain a greater understanding of malware and its characteristics. I plan on analyzing more malware files and documenting the process, however the full assessment of malware can only be achieved in a real-world environment with active attackers attempting to obtain information, which is the dynamic nature of Cybersecurity threats. 
